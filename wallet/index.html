<!--
TODO LICENSE
-->
<!doctype html>
<html>
<head>
<title>Wallet</title>
<script type="text/javascript" language="javascript">

if(document.domain == 'www.wamwallet.org') {
	document.location.replace(document.location.href.replace('www.wamwallet.org', 'wamwallet.org'));
}

/**
	Web Marketplace Wallet
	
	2010-07-15
	First version of wallet code
	-Michael Hanson. Mozilla
**/

function $(id) {
	return document.getElementById(id);
}
function elem(type, clazz) {
	var e = document.createElement(type);
  if (clazz) e.setAttribute("class", clazz);
  return e;
}

var WalletManager = (function() {
	var supported = !!(window.postMessage && window.localStorage && window.JSON);
	var disabled = ('1' == localStorage.getItem('disabled.xauth.org'));
  
  var domainMap = {}; // from domain to array of installs
  var installsByName = []; // sorted in name order
	var manageMode = false;
  
	function setDisabled(disable) {
		disabled = disable;
		localStorage.setItem('disabled.wamwallet.org',disabled?'1':'0');
	}
	
  function loadInstalled()
  {
    domainMap = {};
    installsByName = [];
    for (var i =0;i<localStorage.length;i++)
    {
      var key = localStorage.key(i);
      var item = localStorage.getItem(key);
      //dump("" + key + ": " + item + "\n");
      var array = JSON.parse(item);
      
      domainMap[key] = array;
      for (var j=0;j<array.length;j++)
      {
        installsByName.push(array[j]);
      }
      installsByName.sort(function (a,b) { return a.ticket.name.localeCompare(b.ticket.name); } );
    }
  }
  
	function escapeHTML(str) {
		if (!str || !str.length) { return str; }

		var entities = {
			'&': '&amp;',
			'"': '&quot;',
			'<': '&lt;',
			'>': '&gt;'
		};
		
		var re = /[&"<>]/g;   //"
		return str.replace(re, function (substr) { return entities[substr]; }); 
	}

	function toggleActive() {
		setDisabled(!disabled);
		// updateStatus();
	}

  function render() {
    var box = $("box");
    box.innerHTML = "";
    servers = {};
    
    for (var i=0;i<installsByName.length;i++)
    {
      var install = installsByName[i];
      if (!servers[install.ticket.server]) servers[install.ticket.server] = install.ticket.server;
      
      var div = elem("div", "ticket");
      var a = elem("a");
      a.setAttribute("href", install.ticket.homeURL);

      if (manageMode) {
        var close = elem("div", "closebox");
        div.appendChild(close);
        close.onclick = function() {
          localStorage.removeItem(install.ticket.domain);
          loadInstalled();
          render();
        }
      }

      var img = elem("img");
      img.setAttribute("border", "0");
      if (install.ticket.icon96) {
        img.setAttribute("src", install.ticket.icon96);
      } else {
        img.setAttribute("src", "generic-icon.png");
      }
      var label = elem("div", "ticket_name");
      label.appendChild(document.createTextNode(install.ticket.name));
      a.appendChild(img);
      div.appendChild(a);
      div.appendChild(label);
      box.appendChild(div);
    }
    
    $("servers").innerHTML = "";    
    for (var server in servers)
    {
      var div = elem("div", "server");
      var a = elem("a");
      a.setAttribute("href", server);
      a.appendChild(document.createTextNode(server));
      div.appendChild(a)
      $("servers").appendChild(div);
    }
  }

  function manage() {
    manageMode = true;
    render();
  }

	function init() {
		loadInstalled();
    render();
	}
  

	return {
		init: init,
		toggleActive: toggleActive,
    manage: manage
	}

})();

</script>
<style>
body {
	padding: 0 30px;
	margin: 0;
	font-family: "Helvetica Neue", Helvetica, Arial;
}
a {
  color:#3875D7;
  text-decoration:none;
}
a:hover {
  text-decoration:underline;
}
#control {
  font:9pt Helvetica;
  float:right
}
#servers {
  font:9pt Helvetica;
  float:right
}

.body {
	width: 1000px;
	margin: auto;
}
.ticket {
  display:inline-block;
  padding:12px;
  width:120px;
  height:120px;
  text-align:center;
  position:relative;
}
.closebox {
  position:absolute;
  left:110px;
  top:8px;
  background-image:url("white_close.png");
  background-repeat:no-repeat;
  width:16px;
  height:16px;
  cursor:pointer;
}
.ticket > .ticket_name {
  font:bold 9pt Helvetica
}
#header {
  padding-top:16px;
  font:bold 18pt Helvetica;
  color:#303030;
}

</style>
</head>
<body onload="WalletManager.init()">
	<div id="header">
  Applications
  <div id="control">
  <a href="javascript:WalletManager.manage()">manage</a>
  </div><br clear="all">
  <div id="servers">
  </div>
	</div>
	<div id="box" class="body">
	</div>
</body>
</html>
