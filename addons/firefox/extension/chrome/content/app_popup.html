<html>
<head>
<style>
HTML {
  background-color: transparent;
}

BODY {
  margin: 0 3px; color:white;
  font: message-box; 
  background-color: transparent;
  -moz-border-image: url(chrome://openwebapps/skin/hud-panel.png) 26 50 22 18 / 26px 50px 22px 18px repeat;
}


.appList {
	background: rgba(0,0,0,0);
	-moz-border-radius: 1em;
	border-radius: 1em;
	background-color: rgb(220,220,220);
   -moz-box-shadow:  0 0 2px black;
        box-shadow:  0 0 2px black;
}

.appList:after { content: "."; 
  display: block;
  height: 0;
  clear: both; 
  visibility: hidden; 
}
.split {clear:both;display:inline-block;background-color:green;width:20px;height:20px}

.app {
	display:inline-block;
	position: relative;
	margin: 0px 5px 10px 5px;
  height:96px;
  overflow-y:hidden;
  overflow-x:hidden;
}

.appName{
	color: rgb(220,220,220);
	font-family:Tahoma, sans-serif !important;
	width: 100%;
  font-weight:bold;
	font-size: 10px;
	line-height: 12px;
	top: 116px;
  width:60px;
	text-align: center;
	margin: auto;
  cursor:default;
}

.icon {
	position: relative;
	width: 48px;
	height: 48px;
	text-align: center;
/*	background-image: url('img/default-icon.png');*/
	margin: 10px;
  border:2px solid #d0d0d0 outset;
  
  -moz-transition-property: background-size, top, left, opacity;
  -moz-transition-duration: 500ms, 500ms, 500ms, 500ms;
  -moz-transition-timing-function: ease-in-out;
}

#offer_region {
  width:100%;
  display:none;
	font-family:Tahoma, sans-serif !important;
  color:white;

  -moz-transition-property: height, opacity;
  -moz-transition-duration: 500ms, 500ms;
  -moz-transition-delay: 500ms, 500ms;
  -moz-transition-timing-function: ease-in-out, ease-in-out;
}
#offer_intro {
  font-weight: bold;
  margin-bottom:8px;
}

#offer_details {
  background-color:#101010;
  border:1px inset #202020;
  padding:8px;
  width:400px;
}

#offer_icon {
  width:48px;
  height:48px;
  vertical-align:top;
  margin-right:6px;
  display:inline-block;
}
#offer_name {
  display:block;
  font-weight:bold;
  
}
#offer_desc {
  max-height:64px;
  overflow-y:auto;
}
#offer_controls {
  position: relative;
  min-height:28px;
}
#offer_close {
  float:right;
  width:16px;
  height:16px;
  background-color:#303030;
  border-radius:0.25em;
}
#offer_close_button {
  width:16px;
  height:16px;
  background-image: -moz-image-rect(url(chrome://openwebapps/content/close.png), 0%, 25%, 100%, 0%);
}
#offer_close_button:hover {
  width:16px;
  height:16px;
  background-image: -moz-image-rect(url(chrome://openwebapps/content/close.png), 0%, 50%, 100%, 25%);
}
#install_status {
  font:bold 9pt Helvetica;
  color:red;
}
#offer_install {
  position: absolute;
  right: 10px;
  font: normal normal bold 8pt/normal Helvetica;
  vertical-align: middle;
  text-align: center;
  letter-spacing: -0.5px;
  color: rgb(255,255,255);
  text-shadow: 0px 1px rgba(0, 0, 0, 0.3);
  width: 90px;
  height: 28px;
  line-height: 26px;
  border: 1px solid rgba(0,0,0,0.2);

  -moz-border-radius: 0.5em;
  border-radius: 0.5em;

  -moz-box-shadow:
    inset rgba(218,255,191,1) 0 1px 0px,
    inset rgba(0,0,0,0.2) 0 -2px 0px,
    rgba(0,0,0,0.1) 0 2px 0px;
  -box-shadow:
    inset rgba(218,255,191,1) 0 1px 0px,
    inset rgba(0,0,0,0.2) 0 -2px 0px,
    rgba(0,0,0,0.1) 0 2px 0px;
  background: -moz-linear-gradient(top,  rgba(134,214,106,1), rgba(78,152,52,1)); /* for firefox 3.6+ */
  display: block
}
#icon_region {
}

</style>
</head>
<body>

<div id="offer_region">
  <div id="offer_intro">This web site has an installable web application:</div>

  <div id="offer_details">
<!--    <div id="offer_close"><div id="offer_close_button"></div></div>-->
    <div id="offer_icon"></div>

    <div style="display:inline-block;width:300px">
      <div id="offer_name"></div>
      <div id="offer_desc"></div>
      <div id="install_status"></div>
    </div>

    <div id="offer_controls">
      <button id="offer_install">INSTALL</button>
    </div>
  </div>
</div>

<div id="icon_region"></div>

<script>
Components.utils.import("resource://openwebapps/modules/api.js");

function renderIconList(appDict)
{
  var appCount = 0;
  for (var key in appDict) appCount += 1;
  var height  = Math.ceil(appCount / 5.0) * 100 + (repo.getCurrentPageHasApp() ? 180 : 0);
  document.body.style.height = height;

  var container = document.getElementById("icon_region");
  container.innerHTML = "";
  
  var count = 0;
  for (var appID in appDict) {
    
    container.appendChild(createAppIcon(appDict[appID]));
    if (count && (((count+1) % 5) == 0)) {
      var br = elem("br");
      br.setAttribute("clear", "left");
      container.appendChild(br);
    }
    count += 1;
  }
}


function elem(type, clazz) {
  var e = document.createElement(type);
  if (clazz) e.setAttribute("class", clazz);
  return e;
}

function getBiggestIcon(minifest) {
  //see if the minifest has any icons, and if so, return the largest one
  if (minifest.icons) {
    var biggest = 0;
    for (var z in minifest.icons) {
      var size = parseInt(z, 10);
      if (size > biggest) biggest = size;
    }
    if (biggest !== 0) return minifest.icons[biggest];
  }
  return null;
}

var wiggleInstalled;

function createAppIcon(installRecord)
{
  var app = installRecord.manifest;

  var appContainer = elem("div", "app");
  var clickyIcon = elem("div", "icon");
  var iconImg = getBiggestIcon(app);
  if (iconImg) {
      var iconUrl = installRecord.origin + iconImg;
      clickyIcon.style.background = "url(\"" + iconUrl + "\") no-repeat #404040";
      clickyIcon.style.backgroundSize = "100%";

      if (wiggleInstalled && wiggleInstalled.indexOf(installRecord.origin) == 0) {
        clickyIcon.style.backgroundSize = "50%";
        clickyIcon.style.top = "12px";
        clickyIcon.style.left = "12px";
        clickyIcon.style.opacity = 0.25;
        window.setTimeout(function() {
          clickyIcon.style.top = "0px";
          clickyIcon.style.left = "0px";
          clickyIcon.style.backgroundSize="100%"
          clickyIcon.style.opacity = 1;
        }, 10);
      }
      
  }
  clickyIcon.onclick = function() {
    var url = installRecord.origin;
    if ('launch_path' in app) url = app['launch_path'];
    repo.launch(url);
  };
  appContainer.appendChild(clickyIcon);
  var appName = elem("div", "appName");
  appName.appendChild(document.createTextNode(app.name));
  appName.style.left = "10px";
  appContainer.appendChild(appName);
  
  return appContainer;
}

try {

var repo = FFRepoImplService;
repo.list(function(appDict) {
  renderIconList(appDict);
});

if (repo.getCurrentPageHasApp())
{
  repo.getCurrentPageApp(function(currentPageApp) {
  
    try {
    
      if (currentPageApp) {
        var offer_region = document.getElementById("offer_region");
        offer_region.style.display = "block";
        var offer_name = document.getElementById("offer_name");
        offer_name.appendChild(document.createTextNode(currentPageApp.name));

        var offer_icon = document.getElementById("offer_icon");
        var iconImg = getBiggestIcon(currentPageApp);
        offer_icon.style.background = "url(\"" + iconImg + "\") no-repeat #000000";
        offer_icon.style.backgroundSize = "100%";

        var offer_desc = document.getElementById("offer_desc");
        if (currentPageApp.description) {
          offer_desc.appendChild(document.createTextNode(currentPageApp.description));
        }
        document.getElementById("offer_install").onclick = function() {
          
          var installArgs = 
            {
              url: repo.getCurrentPageAppManifestURL().spec, 
              onerror:function(result) {
                document.getElementById("install_status").appendChild(document.createTextNode("Error: " + result.message));
              },
              onsuccess:function(result) {
                // should animate something cool happening here. :)
                repo.list(function(appDict) {
                  wiggleInstalled = repo.getCurrentPageAppManifestURL().spec;
                  renderIconList(appDict, repo.getCurrentPageAppManifestURL());

                  var off_region = document.getElementById("offer_region");
                  off_region.style.opacity = 0;
                  off_region.style.height = off_region.clientHeight + "px";
                  document.getElementById("icon_region").style.top = off_region.clientHeight + "px";
                  window.setTimeout(function() {
                    off_region.style.height = "0px";
                  }, 500);
                });
              }
            };
          var wm = Components.classes["@mozilla.org/appshell/window-mediator;1"]
                             .getService(Components.interfaces.nsIWindowMediator);
          var recentWindow = wm.getMostRecentWindow("navigator:browser");
            
          repo.install(window.location, installArgs, recentWindow);
        }
      }
    } catch (e) {
      dump("Error with current page app: " + e + "\n");
    }
  });
}

}catch (e) {
  dump(e + "\n");
}

</script>
</body>
</html>