<html>
<head>
<link rel="stylesheet" href="resource://openwebapps/chrome/skin/popup.css">
</head>
<body>

<div id="manage">
    <div id="empty"></div>
    <a href="about:apps" target="_blank">Manage Apps</a>
</div>

<div id="offer_region">
    <div id="offer_intro">This web site has an installable web application:</div>
    <div id="offer_details">
        <!-- <div id="offer_close"><div id="offer_close_button"></div></div> -->
        <div id="offer_icon"></div>
        <div style="display:inline-block;width:300px">
            <div id="offer_name"></div>
            <div id="offer_desc"></div>
            <div id="install_status"></div>
        </div>
        <div id="offer_controls">
            <button id="offer_install">INSTALL</button>
        </div>
    </div>
</div>

<div id="icon_region"></div>

<script>
Components.utils.import("resource://openwebapps/modules/api.js");

function renderIconList(appDict)
{
    var appCount = 0;
    for (var key in appDict) appCount += 1;
    var height    = Math.ceil(appCount / 5.0) * 100 + (repo.getCurrentPageHasApp() ? 180 : 0);
    if (height < 20) height = 20;
    document.body.style.height = height;

    var container = document.getElementById("icon_region");
    container.innerHTML = "";
    
    var count = 0;
    for (var appID in appDict) {
        
        container.appendChild(createAppIcon(appDict[appID]));
        if (count && (((count+1) % 5) == 0)) {
            var br = elem("br");
            br.setAttribute("clear", "left");
            container.appendChild(br);
        }
        count += 1;
    }
    if (count == 0) {
        document.getElementById("empty").appendChild(document.createTextNode("No applications are installed."));
    }
}


function elem(type, clazz) {
    var e = document.createElement(type);
    if (clazz) e.setAttribute("class", clazz);
    return e;
}

function getBiggestIcon(minifest) {
    //see if the minifest has any icons, and if so, return the largest one
    if (minifest.icons) {
        var biggest = 0;
        for (var z in minifest.icons) {
            var size = parseInt(z, 10);
            if (size > biggest) biggest = size;
        }
        if (biggest !== 0) return minifest.icons[biggest];
    }
    return null;
}

var wiggleInstalled;

function createAppIcon(installRecord)
{
    var app = installRecord.manifest;

    var appContainer = elem("div", "app");
    var clickyIcon = elem("div", "icon");
    var iconImg = getBiggestIcon(app);
    if (iconImg) {
            var iconUrl = installRecord.origin + iconImg;
            clickyIcon.style.background = "url(\"" + iconUrl + "\") no-repeat #404040";
            clickyIcon.style.backgroundSize = "100%";

            if (wiggleInstalled && wiggleInstalled.indexOf(installRecord.origin) == 0) {
                clickyIcon.style.backgroundSize = "50%";
                clickyIcon.style.top = "12px";
                clickyIcon.style.left = "12px";
                clickyIcon.style.opacity = 0.25;
                window.setTimeout(function() {
                    clickyIcon.style.top = "0px";
                    clickyIcon.style.left = "0px";
                    clickyIcon.style.backgroundSize="100%"
                    clickyIcon.style.opacity = 1;
                }, 10);
            }
            
    }
    clickyIcon.onclick = function() {
        var url = installRecord.origin;
        repo.launch(url);
    };
    appContainer.appendChild(clickyIcon);
    var appName = elem("div", "appName");
    appName.appendChild(document.createTextNode(app.name));
    appName.style.left = "10px";
    appContainer.appendChild(appName);
    
    return appContainer;
}

try {

var repo = FFRepoImplService;
repo.list(function(appDict) {
    renderIconList(appDict);
});

if (repo.getCurrentPageHasApp())
{
    repo.getCurrentPageApp(function(currentPageApp) {
    
        try {
        
            if (currentPageApp) {
                var wm = Components.classes["@mozilla.org/appshell/window-mediator;1"]
                                                         .getService(Components.interfaces.nsIWindowMediator);
                var recentWindow = wm.getMostRecentWindow("navigator:browser");
                    
                var offer_region = document.getElementById("offer_region");
                offer_region.style.display = "block";
                var offer_name = document.getElementById("offer_name");
                offer_name.appendChild(document.createTextNode(currentPageApp.name));

                var offer_icon = document.getElementById("offer_icon");
                var iconImg = getBiggestIcon(currentPageApp);
                var iconUrl = recentWindow.gBrowser.contentDocument.baseURI + iconImg;
                
                offer_icon.style.background = "url(\"" + iconUrl + "\") no-repeat";
                offer_icon.style.backgroundSize = "100%";

                var offer_desc = document.getElementById("offer_desc");
                if (currentPageApp.description) {
                    offer_desc.appendChild(document.createTextNode(currentPageApp.description));
                }
                document.getElementById("offer_install").onclick = function() {
                    
                    var installArgs = 
                        {
                            url: repo.getCurrentPageAppManifestURL().spec, 
                            onerror:function(result) {
                                document.getElementById("install_status").appendChild(document.createTextNode("Error: " + result.message));
                            },
                            onsuccess:function(result) {
                                // should animate something cool happening here. :)
                                repo.list(function(appDict) {
                                    wiggleInstalled = repo.getCurrentPageAppManifestURL().spec;
                                    renderIconList(appDict, repo.getCurrentPageAppManifestURL());

                                    var off_region = document.getElementById("offer_region");
                                    off_region.style.opacity = 0;
                                    off_region.style.height = off_region.clientHeight + "px";
                                    document.getElementById("icon_region").style.top = off_region.clientHeight + "px";
                                    window.setTimeout(function() {
                                        off_region.style.height = "0px";
                                    }, 500);
                                });
                            }
                        };
                    repo.install(window.location, installArgs, recentWindow);
                }
            }
        } catch (e) {
            dump("Error with current page app: " + e + "\n");
        }
    });
}

} catch (e) {
    dump(e + "\n");
}

</script>
</body>
</html>