<html>
<head>
  <title>Write Your Own App Description</title>

  <script type="text/javascript" src="https://myapps.mozillalabs.com/js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="https://myapps.mozillalabs.com/jsapi/include.js"></script>
  <script type="text/javascript" src="https://myapps.mozillalabs.com/js/manifest.js"></script>
  <script type="text/javascript" src="templating.js"></script>

<script type="template" id="manifest_template">{
  name: "<%= doc.title %>",
  description: "",
  app: {
    urls: ["<%= url %>"],
    launch: {
      web_url: "<%= url %>"
    }
  },
  icons: {
    "48": "<%= doc.favicon() %>"
  }
}
</script>

<script type="text/javascript">

function installManifest() {
  var el = $('#results');
  var data = $('#manifest').val();
  try {
    data = eval("("+data+")");
  } catch (e) {
    displayError(e, "Failure to parse manifest");
    throw e;
  }
  try {
    Manifest.validate(data);
  } catch (e) {
    displayError(e, "Failure to validate manifest");
    throw e;
  }
  try {
    AppClient.install({manifest: data});
  } catch (e) {
    displayError(e, "Failure to install manifest");
    throw e;
  }
  $('#results').text("Success at " + (new Date()));
}

function displayError(error, message) {
  var el = $('#results');
  var text = message + ": " + error + " ("+(new Date())+")";
  var pre = null;
  if (text.length > 80) {
    var pre = $('<pre>');
    pre.text(text);
    text = "";
  }
  if (typeof error != 'string') {
    for (i in error) {
      text += '<br />\n'+i+'=<code>'+error[i]+'</code>';
    }
  }
  el.text(text);
  if (pre) {
    el.append(pre);
  }
}

function generateManifest(url) {
  $.get('/subreq?follow=1&uri=' + escape(url), function (page) {
    try {
      var doc = parsePage(page, url);
      var manifest = tmpl("manifest_template", {doc: doc, url: url});
      $('#manifest').val(manifest);
      $('#results').text('Generated from ' + url + ' at ' + (new Date()));
    } catch (e) {
      displayError(e, "Error creating manifest from " + url);
      throw e;
    }
  });
}

function parsePage(page, url) {
  var title = /<title>([^<]*)<\/title>/i;
  var link = /<link\s+([^>]*)\s*\/?>/i;
  var attribute = /([a-z0-9:_\-]+)\s*=\s*"([^"]*)"/i;
  doc = new Document(url);
  var match = title.exec(page);
  if (match) {
    doc.title = match[1];
  }
  $.each(allMatches(link, page), function () {
    link = new Link();
    $.each(allMatches(attribute, this[0]), function () {
      link[this[1]] = this[2];
    });
    doc.links.push(link);
  });
  return doc;
}

function Document(url) {
  this.url = url;
  this.title = null;
  this.links = [];
}

Document.prototype.toString = function () {
  doc = 'Document(title: ' + this.title + ', links: ' + this.links + ')';
};

Document.prototype.findLink = function (rel, type) {
  results = [];
  for (i in this.links) {
    var link = this.links[i];
    if ((! rel || link.rel.toLowerCase() == rel)
        && (! type || link.type.toLowerCase() == type)) {
        results.push(link);
    }
  }
  if (results.length) {
    return results[0].href;
  } else {
    return null;
  }
};

Document.prototype.favicon = function () {
  var icon = this.findLink('shortcut icon')
    || this.url + '/favicon.ico';
  return icon;
};

function Link() {
  this.rel = null;
  this.type = null;
  this.href = null;
}

Link.prototype.toString = function () {
  var attrs = [];
  for (i in this) {
    if (this[i] !== this.prototype[i]) {
      attrs.push(i + '="' + this[i] + '"');
    }
  }
  var s = '<link';
  if (attrs.length) {
    s += ' ' + attrs.join(' ');
  }
  return s + '>';
};

function allMatches(regex, string) {
  var result = [];
  while (1) {
    var match = regex.exec(string)
    if (! match) {
      break;
    }
    result.push(match);
    string = string.substring(match.index + match[0].length);
  }
  return result;
}

// Can be used in the JSON
var facebookIcon =
"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAMAAAAoLQ9TAAADAFBMVEU7WZhFYp5geKtheaxthLTr7vT///8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQEBARERESEhITExMUFBQVFRUWFhYXFxcYGBgZGRkaGhobGxscHBwdHR0eHh4fHx8gICAhISEiIiIjIyMkJCQlJSUmJiYnJycoKCgpKSkqKiorKyssLCwtLS0uLi4vLy8wMDAxMTEyMjIzMzM0NDQ1NTU2NjY3Nzc4ODg5OTk6Ojo7Ozs8PDw9PT0+Pj4/Pz9AQEBBQUFCQkJDQ0NERERFRUVGRkZHR0dISEhJSUlKSkpLS0tMTExNTU1OTk5PT09QUFBRUVFSUlJTU1NUVFRVVVVWVlZXV1dYWFhZWVlaWlpbW1tcXFxdXV1eXl5fX19gYGBhYWFiYmJjY2NkZGRlZWVmZmZnZ2doaGhpaWlqampra2tsbGxtbW1ubm5vb29wcHBxcXFycnJzc3N0dHR1dXV2dnZ3d3d4eHh5eXl6enp7e3t8fHx9fX1+fn5/f3+AgICBgYGCgoKDg4OEhISFhYWGhoaHh4eIiIiJiYmKioqLi4uMjIyNjY2Ojo6Pj4+QkJCRkZGSkpKTk5OUlJSVlZWWlpaXl5eYmJiZmZmampqbm5ucnJydnZ2enp6fn5+goKChoaGioqKjo6OkpKSlpaWmpqanp6eoqKipqamqqqqrq6usrKytra2urq6vr6+wsLCxsbGysrKzs7O0tLS1tbW2tra3t7e4uLi5ubm6urq7u7u8vLy9vb2+vr6/v7/AwMDBwcHCwsLDw8PExMTFxcXGxsbHx8fIyMjJycnKysrLy8vMzMzNzc3Ozs7Pz8/Q0NDR0dHS0tLT09PU1NTV1dXW1tbX19fY2NjZ2dna2trb29vc3Nzd3d3e3t7f39/g4ODh4eHi4uLj4+Pk5OTl5eXm5ubn5+fo6Ojp6enq6urr6+vs7Ozt7e3u7u7v7+/w8PDx8fHy8vLz8/P09PT19fX29vb39/f4+Pj5+fn6+vr7+/v8/Pz9/f3+/v7///9GQ0PUAAAAQUlEQVR4nJXPQQoAIAhEUc0c73/jrDZqEfQXgm8hSFYiEwqJA6UCNAUS+J5hri/AKoD6CdWvGwG47wAffIPjudIAXTsCx6WYSmEAAAAASUVORK5CYII=";

$(function () {
  $('#install').click(installManifest);

  localhostHref = "http://localhost:8125";
  if (location.href.substr(0, localhostHref.length) == localhostHref) {
    $('#myapps-link').attr('href', 'http://localhost:8123');
  }

  $('#generate').click(function () {
    var url = $('#url').val();
    generateManifest(url);
  });
});


</script>

</head>
<body>

<h1>Write Your Own App Description</h1>

<div>This let's you write an app manifest and install it directly.
See <a href="http://etherpad.mozilla.org:9000/webAppManifest">this
document</a> for more information on the manifest.  Go to
<a id="myapps-link" href="http://myapps.mozillalabs.com">myapps</a>
to see the installed app.
</div>

<div>
  <form>
  Manifest:<br />
<textarea id="manifest" style="height: 60%; width: 100%">{
  name: "My Test App",
  description: "A description (plain text)",
  app: {
    // URLs that will be detected as this app, and within this app
    // (includes everything that textually starts with any of these URLs):
    urls: ["http://example.com/"],
    // Starting URL when opening the app:
    launch: {
      web_url: "http://example.com/"
    }
  },
  icons: {
    // Can include "48"/etc, with either data or URLs to the icons
    // You can use this for a simple Facebook icon:
    // "48": facebookIcon
  }
}
</textarea><br />

<button type="button" id="install">Install this</button>
<input type="reset" value="Reset" /> <br />

Generate manifest from site/URL:
<input type="url" id="url" style="width: 10em" />
<button type="button" id="generate">Generate</button>

  </form>
</div>

<h2>Installation results:</h2>

<div id="results">Nothing installed yet.</div>

<script>
</script>

</body>
</html>
