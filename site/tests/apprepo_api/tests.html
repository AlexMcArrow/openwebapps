<html>
<head>
  <title>App Repo API Tests</title>
  <script type="text/javascript" src="doctestjs/doctest.js"></script>
  <link rel="stylesheet" type="text/css" href="doctestjs/doctest.css" />
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
</head>
<body>
<h2> App Repo API Tests </h2>

<p>
  These API tests run in a local environment provided by a test
  server.  There are multiple local bound ports which coincide with
  different running apps.  By including /servers.js from the test
  server, window.SERVERS is populated with a map of server names
  (directory names) to URL where that app can be accessed.
</p>

<div>
  <button onclick="doctest()" type="button">Test all</button>
  <pre id="doctestOutput"></pre>
</div>

<h3>Verify Testing Environment</h3>

First let's ensure that the testing environment is sane...
<pre class="doctest">
$ var dirs = [];
> for (var k in SERVERS) dirs.push(k);
> dirs.sort();
["_primary", "basic_app", "json_syntax_error"]
</pre>

<h3>Clear All Apps</h3>

Delete all applications and then verify that list() yields no apps.

<pre class="doctest">
$ var finished = false;
$ navigator.apps.mgmt.list(function(m) {
>  var total = 0;
>  for (var k in m) if (m.hasOwnProperty(k)) total++;
>  finished = (total === 0);
>  for (var k in m) {
>    if (!m.hasOwnProperty(k)) continue;
>    navigator.apps.mgmt.remove(k, function(r) {
>      finished = (--total === 0);
>    });
>  }
> });
$ wait(function() { return finished; });
$ finished = false;
$ navigator.apps.mgmt.list(Spy('apps.mgmt.list', {wait: true}));
apps.mgmt.list({})
</pre>

<h3>Install a basic application</h3>

<pre class="doctest">
$ navigator.apps.install(
>   {url: SERVERS['basic_app'] + "/manifest.webapp",
>    onsuccess: Spy('apps.install', {wait: true, ignoreThis: true})
>   });
apps.install(true)
$ navigator.apps.mgmt.list(Spy('apps.mgmt.list', {wait: true, wrapArgs: true}));
apps.mgmt.list({
  http://127.0.0.1:...: {
    install_time: ...,
    install_url: "http://127.0.0.1:...",
    manifest: {
      default_locale: "en",
      installs_allowed_from: ["*"],
      name: "Super Crazy Basic App"
    },
    origin: "http://127.0.0.1:..."
  }
})
</pre>

<h3>Re-install that application with a different manifest</h3>

this should be considered an "upgrade", because we may not have
two manifests per origin.

<pre class="doctest">
$ navigator.apps.install(
>   {url: SERVERS['basic_app'] + "/manifest2.webapp",
>    onsuccess: Spy('apps.install', {wait: true, ignoreThis: true})
>   });
apps.install(true)
$ navigator.apps.mgmt.list(Spy('apps.mgmt.list', {wait: true, wrapArgs: true}));
apps.mgmt.list({
  http://127.0.0.1:...: {
    install_time: ...,
    install_url: "http://127.0.0.1:...",
    manifest: {
      default_locale: "en",
      installs_allowed_from: ["*"],
      name: "Wild and Crazy Basic App"
    },
    origin: "http://127.0.0.1:..."
  }
})
</pre>

<h3>We installed it, getInstalledBy should return it.</h3>

<pre class="doctest">
$ navigator.apps.getInstalledBy(Spy('apps.getInstalledBy', {wait: true, ignoreThis: true}));
apps.getInstalledBy([
  {
    install_time: ...,
    install_url: "http://127.0.0.1:...",
    manifest: {default_locale: "en", installs_allowed_from: ["*"], name: "Wild and Crazy Basic App"},
    origin: "http://127.0.0.1:..."
  }
])
</pre>

<h3>getInstalled should not.</h3>

<pre class="doctest">
$ navigator.apps.getInstalled(Spy('apps.getInstalled', {wait: true, ignoreThis: true}));
apps.getInstalled([])
</pre>

<h3>Installation of an app with a syntax error in manifest</h3>

<pre class="doctest">
$ navigator.apps.install(
>   {url: SERVERS['json_syntax_error'] + "/manifest.webapp",
>    onsuccess: Spy('apps.install.success', {wait: false, ignoreThis: true}),
>    onerror: Spy('apps.install.error', {wait: true, ignoreThis: true})
>   });
apps.install.error({code: "manifestParseError", message: "couldn't parse manifest JSON from http://127.0.0.1:.../manifest.webapp"})
</pre>


  <button onclick="doctest()" type="button">Test all</button>

</body>
<script type="text/javascript" src="/servers.js"></script>
<script type="text/javascript" src="/jsapi/include.js"></script>
<script type="text/javascript">
  navigator.apps.setRepoOrigin(SERVERS['_primary']);
</script>
</html>
